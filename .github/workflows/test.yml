name: jami-store-requests-manager
run-name: New organization request from ${{ github.actor }}
on:
  issue_comment:
    types: [created, edited]
jobs:
  set-up:
    if: contains(github.event.issue.labels.*.name, 'new upload request') && startsWith(github.event.comment.body, '/upload')
    runs-on:  ubuntu-latest
    outputs:
      attachements: ${{ steps.verify_attached_plugin.outputs.result }}
      repo: ${{ steps.repo.outputs.result }}
      fileName: ${{ steps.request.outputs.result }}
    steps:
      - name: verify the plugin file is attached
        id: verify_attached_plugin
        uses: actions/github-script@v6
        with:
          script: |
            const regex = /https:\/\/github\.com\/.*\/files\/.*\/*.gz/;
            const comment = ${{ toJSON(github.event.comment) }};
            const attachements = comment.body.match(regex);
            console.log(attachements)
            return attachements;
      - name: get-request-file-name
        id: request
        uses: actions/github-script@v6
        with:
          script: |
            const request = "${{ fromJSON(steps.verify_attached_plugin.outputs.result)[0] }}"
            const extensionIndex = request.split("/").at(-1).lastIndexOf(".");
            fileName = request.substring(0, extensionIndex);
            return fileName;
      - name: get-repo-base-name
        id: repo
        uses: actions/github-script@v6
        with:
          script: |
            const repo = "${{ github.repository }}"
            baseName = repo.split("/").at(-1);
            return baseName;

  set-plugin-tool:
    if: contains(github.event.issue.labels.*.name, 'new upload request') && startsWith(github.event.comment.body, '/upload')
    runs-on:  ubuntu-latest
    steps:
    - name: checkout jami-plugin repo
      id: checkout-plugin-repo
      uses: actions/checkout@v3
      with:
        repository: 'https://review.jami.net/jami-plugins'
        ref: 'master'
        path: './jami-plugin'
    - name: install dependencies for jami-plugin
      run: |
        cd ${{ github.workspace }}/jami-plugin
        pip3 install -r requirements.txt && pip3 install -r certificate_requirements.txt

  print-attachement:
    runs-on:  ubuntu-latest
    needs: [set-up]
    steps:
      - name: print
        run: echo ${{ toJSON(needs.set-up.outputs.attachements)[0] }}
  handle-bad-csr:
    runs-on:  ubuntu-latest
    permissions:
      issues: write
    needs: [set-up]
    if: needs.set-up.outputs.attachements == 'null'
    steps:
      - name: ask to upload the plugin file
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ github.event.issue.number }},
              owner: "${{ github.repository_owner}}",
              repo: ${{ needs.set-up.outputs.repo }},
              body: "@${{ github.actor }} Please upload your plugin to your comment and verify that your file is a gz."
            })
  verify-certificate:
    if: needs.set-up.outputs.attachements != 'null'
    runs-on:  ubuntu-latest
    permissions:
      issues: write
    needs: [set-up, set-plugin-tool]
    steps:
      - name: comment-verification-in-progress
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ github.event.issue.number }},
              owner: "${{ github.repository_owner}}",
              repo: ${{ needs.set-up.outputs.repo }},
              body: |
                the plugin file uploaded, verification in progress
            })
      - name: add label to process the request
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.addLabels({
              issue_number: ${{ github.event.issue.number }},
              owner: "${{ github.repository_owner}}",
              repo: ${{ needs.set-up.outputs.repo }},
              labels: ['plugin certificate verification in progress']
            })
      - name: request verify the plugin certiuficate
        id: request-verify-plugin-certificate
        run: |
          verification=$(wget -O - -o /dev/null ${{ fromJSON(needs.set-up.outputs.attachements)[0] }} | gzip -dc | openssl req -noout  -verify 2>&1)
          echo "verification=${verification}" >> $GITHUB_OUTPUT
      - name: handle error
        if: endsWith(steps.request-verify-plugin-certificate.outputs.verification, 'OK') == false || failure()
        id: request-verify-csr-error
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ github.event.issue.number }},
              owner: "${{ github.repository_owner}}",
              repo: ${{ needs.set-up.outputs.repo }},
              body: 'the plugin is invalid, Please retry'
            })
            github.rest.issues.addLabels({
              issue_number: ${{ github.event.issue.number }},
              owner: "${{ github.repository_owner}}",
              repo: ${{ needs.set-up.outputs.repo }},
              labels: ['invalid plugin certificate']
            })
      - name: handle success when requesting verify the csr
        if: endsWith(steps.request-verify-plugin-certificate.outputs.verification, 'OK')
        uses: actions/github-script@v6
        continue-on-error: true
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ github.event.issue.number }},
              owner: "${{ github.repository_owner}}",
              repo: ${{ needs.set-up.outputs.repo }},
              body: '${{ github.actor}}, your plugin certificate is valid. Please wait to verify the signature.'
            })
            github.rest.issues.addLabels({
              issue_number: ${{ github.event.issue.number }},
              owner: "${{ github.repository_owner}}",
              repo: ${{ needs.set-up.outputs.repo }},
              labels: ['valid plugin certificate']
            })
            github.rest.issues.removeLabel({
              issue_number: ${{ github.event.issue.number }},
              owner: "${{ github.repository_owner}}",
              repo: ${{ needs.set-up.outputs.repo }},
              name: ['invalid plugin certificate']
            })
            github.rest.issues.removeLabel({
              issue_number: ${{ github.event.issue.number }},
              owner: "${{ github.repository_owner}}",
              repo: ${{ needs.set-up.outputs.repo }},
              name: ['plugin certificate verification in progress']
            })
  verify-signature:
    if: needs.set-up.outputs.attachements != 'null'
    runs-on:  ubuntu-latest
    permissions:
        issues: write
    needs: [set-up, set-plugin-tool, verify-certificate]
    steps:
      - name: add comment to inform the user that the signature is in progress
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ github.event.issue.number }},
              owner: "${{ github.repository_owner}}",
              repo: ${{ needs.set-up.outputs.repo }},
              body: |
                Signature verification in progress
            })
      - name: add label to process the request
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.addLabels({
              issue_number: ${{ github.event.issue.number }},
              owner: "${{ github.repository_owner}}",
              repo: ${{ needs.set-up.outputs.repo }},
              labels: ['verification in progress']
            })
      - name: verify the signature
        id: verify-signature
        run: |
          wget -O /tmp/plugin.jpl.gz -o /dev/null ${{ fromJSON(needs.set-up.outputs.attachements)[0] }}
          cd ${{ github.workspace }}/jami-plugin/SDK
          signature_verification=$(python3 ./certKey.py archive verify --path /tmp/plugin.jpl.gz 2>&1)
          echo "signature_verification=${signature_verification}" >> $GITHUB_OUTPUT
